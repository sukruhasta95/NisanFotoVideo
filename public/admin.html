<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <title>Admin Panel</title>
  <style>
    body {
      font-family: sans-serif;
      background: #efb6b6;
      margin: 0;
      padding: 1rem;
    }

    h1 {
      text-align: center;
    }

    .toolbar {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .media-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
    }

    .file-preview {
      position: relative;
      display: inline-block;
      margin: 10px;
    }

    .file-preview video,
    .file-preview img {
      width: 200px;
      height: auto;
      display: block;
    }

    .media-card {
      width: 200px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      position: relative;
    }

    .media-card input[type="checkbox"] {
      position: absolute;
      top: 5px;
      left: 5px;
      transform: scale(1.5);
      width: 10%;
      height: 10%;
      margin: 3%;
      z-index: 10;
    }

    .media-card img,
    .media-card video {
      width: 100%;
      height: auto;
      display: block;
    }

    .media-actions {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem;
    }

    button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }

    button.danger {
      background-color: #dc3545;
    }

    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 1rem;
      gap: 0.5rem;
    }

    .pagination button {
      padding: 6px 12px;
      font-size: 14px;
    }

    .loader {
      border: 6px solid #6e30e9;
      border-top: 6px solid #feddc1;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(255, 255, 255, 0.7);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      pointer-events: all;
    }

    #countdownText {
      font-size: 22px;
      font-weight: bold;
      color: #333;
      margin-top: 15px;
      text-align: center;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <div id="loadingOverlay">
    <div class="loader"></div>
    <div id="countdownText">Dosyalar hazırlanıyor...</div>
  </div>
  <h1>Yüklenen Dosyalar</h1>
  <div class="toolbar">
    <button onclick="toggleSelectAll()">Tümünü Seç / Temizle</button>
    <button onclick="downloadSelected()">Seçilenleri İndir</button>
    <button class="danger" onclick="deleteSelected()">Seçilenleri Sil</button>
    <button onclick="fetchMedia(currentPage)">Yenile</button>
  </div>
  <div class="media-grid" id="mediaGrid"></div>
  <div class="pagination" id="pagination"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    let allSelected = false;
    let currentPage = 1;
    const pageSize = 20;

    async function fetchMedia(page = 1) {
      currentPage = page;
      const res = await fetch(`/uploads?page=${page}&pageSize=${pageSize}`);
      const { files, total } = await res.json();

      const grid = document.getElementById('mediaGrid');
      grid.innerHTML = '';

      files.forEach(file => {
        const ext = file.split('.').pop().toLowerCase();
        const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext);
        const isVideo = ['mp4', 'mov', 'webm'].includes(ext);

        const card = document.createElement('div');
        card.className = 'media-card';
        card.innerHTML = `
          <input type="checkbox" value="${file}">
          ${isImage ? `<img src="/uploads/${file}">` : ''}
          ${isVideo ? `<video controls src="/uploads/${file}"></video>` : ''}
          <div class="media-actions">
            <span>${file}</span>
          </div>
        `;
        grid.appendChild(card);
      });

      renderPagination(total, page);
    }

    function renderPagination(total, page) {
      const pageCount = Math.ceil(total / pageSize);
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';

      for (let i = 1; i <= pageCount; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.disabled = i === page;
        btn.onclick = () => fetchMedia(i);
        pagination.appendChild(btn);
      }
    }

    function getSelectedFiles() {
      return [...document.querySelectorAll('.media-card input[type="checkbox"]:checked')]
        .map(cb => cb.value);
    }

    function toggleSelectAll() {
      allSelected = !allSelected;
      document.querySelectorAll('.media-card input[type="checkbox"]').forEach(cb => cb.checked = allSelected);
    }

    async function deleteSelected() {
      const selected = getSelectedFiles();
      if (selected.length === 0) return alert("Silmek için dosya seçin.");
      if (!confirm(`${selected.length} dosya silinecek. Emin misiniz?`)) return;

      const res = await fetch('/api/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ files: selected })
      });

      if (res.ok) {
        alert("Dosyalar silindi.");
        fetchMedia(currentPage);
      } else {
        alert("Silme işlemi başarısız.");
      }
    }
    fetchMedia();
  </script>

  <script>
    async function downloadSelected() {
      const selected = getSelectedFiles();
      if (selected.length === 0) {
        alert("Lütfen indirilecek dosya(ları) seçin.");
        return;
      }

      const overlay = document.getElementById('loadingOverlay');
      const countdownText = document.getElementById('countdownText');
      overlay.style.display = 'flex';
      overlay.style.zIndex = '9999';

      const zip = new JSZip();
      const folder = zip.folder("nisan-anilari");
      let completed = 0;
      const fileSizes = [];

      let totalSizeBytes = 0;
      const sizeFetches = selected.slice(0, 3).map(filename =>
        fetch(`/uploads/${filename}`, { method: "HEAD" }).then(res => {
          const size = res.headers.get("Content-Length");
          if (size) totalSizeBytes += parseInt(size);
        })
      );
      await Promise.all(sizeFetches);
      const estimatedSeconds = (totalSizeBytes) / (estimatedDownloadSpeedMbps * 1024 * 1024);
      console.log("toplam dosya boyutu:",totalSizeBytes)
      let secondsRemaining = estimatedSeconds;
      countdownText.innerText = `Dosyalar hazırlanıyor. Tahmini süre: ${Math.ceil(secondsRemaining)} sn`;
      const countdownInterval = setInterval(() => {
        secondsRemaining -= 1;
        if (secondsRemaining <= 0) return;
        countdownText.innerText = `Dosyalar hazırlanıyor. Tahmini süre: ${Math.ceil(secondsRemaining)} sn`;
      }, 1000);

      for (const filename of selected) {
        try {
          const res = await fetch(`/uploads/${filename}`);
          const blob = await res.blob();
          folder.file(filename, blob);
          completed++;
        } catch (err) {
          alert(`Dosya alınamadı ${filename}`);
        }
      }

      clearInterval(countdownInterval);
      countdownText.innerText = `Zip hazırlanıyor...`;
      zip.generateAsync({ type: "blob" }).then(content => {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(content);
        a.download = "nisan-anilari.zip";
        a.click();

        overlay.style.display = 'none';
      });
    }
  </script>

  <script>
    let estimatedDownloadSpeedMbps = 30; 
    async function measureDownloadSpeed() {
      const testUrl = "https://speed.cloudflare.com/__down?bytes=5000000";
      try {
        const start = performance.now();
        const response = await fetch(testUrl, { cache: "no-cache" });
        const blob = await response.blob();
        const end = performance.now();

        const duration = (end - start) / 1000;
        const bitsLoaded = blob.size * 8;
        estimatedDownloadSpeedMbps = bitsLoaded / duration / 1024 / 1024;
         console.log("estimatedDownloadSpeedMbps", estimatedDownloadSpeedMbps);
      } catch (err) {
        console.log("Hız ölçümünde hata:", err);
      }
    }
    measureDownloadSpeed();
  </script>

</body>

</html>