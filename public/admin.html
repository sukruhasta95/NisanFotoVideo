<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <title>Admin Panel</title>
  <link rel="icon" href="https://img.icons8.com/?size=100&id=Z5Cz9gML8rsf&format=png&color=000000" type="image/png">
  <style>
    body {
      font-family: sans-serif;
      background: #efb6b6;
      margin: 0;
      padding: 1rem;
    }

    h1 {
      text-align: center;
    }

    .toolbar {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .media-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
    }

    .file-preview {
      position: relative;
      display: inline-block;
      margin: 10px;
    }

    .file-preview video,
    .file-preview img {
      width: 200px;
      height: auto;
      display: block;
    }

    .media-card {
      width: 200px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      position: relative;
    }

    .media-card input[type="checkbox"] {
      position: absolute;
      top: 5px;
      left: 5px;
      transform: scale(1.5);
      width: 10%;
      height: 10%;
      margin: 3%;
      z-index: 10;
    }

    .media-card img,
    .media-card video {
      width: 100%;
      height: auto;
      display: block;
    }

    .media-actions {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem;
    }

    button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }

    button.danger {
      background-color: #dc3545;
    }

    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 1rem;
      gap: 0.5rem;
    }

    .pagination button {
      padding: 6px 12px;
      font-size: 14px;
    }

    .loader {
      border: 6px solid #6e30e9;
      border-top: 6px solid #feddc1;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(255, 255, 255, 0.7);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      pointer-events: all;
    }

    #countdownText {
      font-size: 22px;
      font-weight: bold;
      color: #333;
      margin-top: 15px;
      text-align: center;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <div id="loadingOverlay">
    <div class="loader"></div>
    <div id="countdownText">Dosyalar hazırlanıyor...</div>
  </div>
  <h1>Yüklenen Dosyalar</h1>
  <div class="toolbar">
    <button onclick="toggleSelectAll()">Tümünü Seç / Temizle</button>
    <button onclick="downloadSelected()">Seçilenleri İndir</button>
    <button class="danger" onclick="deleteSelected()">Seçilenleri Sil</button>
    <button onclick="fetchMedia(currentPage)">Yenile</button>
  </div>
  <div class="media-grid" id="mediaGrid"></div>
  <div class="pagination" id="pagination"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    let allSelected = false;
    let currentPage = 1;
    const pageSize = 20;


    async function fetchMedia(page = 1) {
      currentPage = page;
      const res = await fetch(`/uploads?page=${page}&pageSize=${pageSize}`);
      const { files, total } = await res.json();

      const grid = document.getElementById('mediaGrid');
      grid.innerHTML = '';

      files.forEach((file, i) => {
        const ext = file.split('.').pop().toLowerCase();
        const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext);
        const isVideo = ['mp4', 'mov', 'webm'].includes(ext);

        const card = document.createElement('div');
        card.className = 'media-card';

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = file;
        card.appendChild(cb);

        if (isImage) {
          const img = document.createElement('img');
          img.src = `/uploads/${encodeURI(file)}`;
          img.style.cursor = 'pointer';
          img.addEventListener('click', () => openLightbox(files, i));
          card.appendChild(img);
        } else if (isVideo) {
          const vid = document.createElement('video');
          vid.src = `/uploads/${encodeURI(file)}`;
          vid.controls = true;
          vid.style.cursor = 'pointer';
          vid.addEventListener('click', () => openLightbox(files, i));
          card.appendChild(vid);
        }

        const actions = document.createElement('div');
        actions.className = 'media-actions';
        const nameSpan = document.createElement('span');
        nameSpan.textContent = file;
        nameSpan.title = file;
        actions.appendChild(nameSpan);
        card.appendChild(actions);

        grid.appendChild(card);
      });

      renderPagination(total, page);
    }

    function renderPagination(total, page) {
      const pageCount = Math.ceil(total / pageSize);
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';

      for (let i = 1; i <= pageCount; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.disabled = i === page;
        btn.onclick = () => fetchMedia(i);
        pagination.appendChild(btn);
      }
    }

    function getSelectedFiles() {
      return [...document.querySelectorAll('.media-card input[type="checkbox"]:checked')]
        .map(cb => cb.value);
    }

    function toggleSelectAll() {
      allSelected = !allSelected;
      document.querySelectorAll('.media-card input[type="checkbox"]').forEach(cb => cb.checked = allSelected);
    }

    async function deleteSelected() {
      const selected = getSelectedFiles();
      if (selected.length === 0) return alert("Silmek için dosya seçin.");
      if (!confirm(`${selected.length} dosya silinecek. Emin misiniz?`)) return;

      const res = await fetch('/api/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ files: selected })
      });

      if (res.ok) {
        alert("Dosyalar silindi.");
        fetchMedia(currentPage);
      } else {
        alert("Silme işlemi başarısız.");
      }
    }
    fetchMedia();
  </script>

  <script>
    async function downloadSelected() {
      const selected = getSelectedFiles();
      if (selected.length === 0) {
        alert("Lütfen indirilecek dosya(ları) seçin.");
        return;
      }

      const overlay = document.getElementById('loadingOverlay');
      const countdownText = document.getElementById('countdownText');
      overlay.style.display = 'flex';
      overlay.style.zIndex = '9999';

      const zip = new JSZip();
      const folder = zip.folder("nisan-anilari");
      let completed = 0;
      const fileSizes = [];

      let totalSizeBytes = 0;
      const sizeFetches = selected.slice(0, 3).map(filename =>
        fetch(`/uploads/${filename}`, { method: "HEAD" }).then(res => {
          const size = res.headers.get("Content-Length");
          if (size) totalSizeBytes += parseInt(size);
        })
      );
      await Promise.all(sizeFetches);
      const estimatedSeconds = (totalSizeBytes) / (estimatedDownloadSpeedMbps * 1024 * 1024);
      console.log("toplam dosya boyutu:", totalSizeBytes)
      let secondsRemaining = estimatedSeconds;
      countdownText.innerText = `Dosyalar hazırlanıyor. Tahmini süre: ${Math.ceil(secondsRemaining)} sn`;
      const countdownInterval = setInterval(() => {
        secondsRemaining -= 1;
        if (secondsRemaining <= 0) return;
        countdownText.innerText = `Dosyalar hazırlanıyor. Tahmini süre: ${Math.ceil(secondsRemaining)} sn`;
      }, 1000);

      for (const filename of selected) {
        try {
          const res = await fetch(`/uploads/${filename}`);
          const blob = await res.blob();
          folder.file(filename, blob);
          completed++;
        } catch (err) {
          alert(`Dosya alınamadı ${filename}`);
        }
      }

      clearInterval(countdownInterval);
      countdownText.innerText = `Zip hazırlanıyor...`;
      zip.generateAsync({ type: "blob" }).then(content => {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(content);
        a.download = "nisan-anilari.zip";
        a.click();

        overlay.style.display = 'none';
      });
    }
  </script>

  <script>
    let estimatedDownloadSpeedMbps = 30;
    async function measureDownloadSpeed() {
      const testUrl = "https://speed.cloudflare.com/__down?bytes=5000000";
      try {
        const start = performance.now();
        const response = await fetch(testUrl, { cache: "no-cache" });
        const blob = await response.blob();
        const end = performance.now();

        const duration = (end - start) / 1000;
        const bitsLoaded = blob.size * 8;
        estimatedDownloadSpeedMbps = bitsLoaded / duration / 1024 / 1024;
        console.log("estimatedDownloadSpeedMbps", estimatedDownloadSpeedMbps);
      } catch (err) {
        console.log("Hız ölçümünde hata:", err);
      }
    }
    measureDownloadSpeed();
  </script>

  <div id="imgModal" style="
  display:none; 
  position:fixed; 
  z-index:99999; 
  top:0; left:0; right:0; bottom:0; 
  background:rgba(0,0,0,0.9); 
  justify-content:center; 
  align-items:center;">

    <span onclick="closeImgModal()" style="
    position:absolute; 
    top:2%; 
    left:90%; 
    color:#fff; 
    font-size:xx-large; 
    font-weight:bold; 
    cursor:pointer;">&times;</span>
    <img id="imgModalContent" style="max-width:90%; max-height:90%; border-radius:10px;">
  </div>

  <script>
    function openImgModal(src) {
      const modal = document.getElementById('imgModal');
      document.getElementById('imgModalContent').src = src;
      modal.style.display = 'flex';
    }

    function closeImgModal() {
      document.getElementById('imgModal').style.display = 'none';
    }

    document.getElementById('imgModal').addEventListener('click', function (e) {
      if (e.target.id === 'imgModal') {
        closeImgModal();
      }
    });
  </script>

  <!-- UNIVERSAL LIGHTBOX (foto + video) -->
  <div id="lightbox" style="
  display:none; position:fixed; inset:0; z-index:99999;
  background:rgba(0,0,0,.92); justify-content:center; align-items:center;">
    <!-- Kapat -->
    <button id="lbClose" aria-label="Kapat" style="
    position:absolute; top:16px; right:20px; font-size:28px; 
    background:transparent; color:#fff; border:0; cursor:pointer;">✕</button>
    <!-- Önceki -->
    <button id="lbPrev" aria-label="Önceki" style="
    position:absolute; left:2%; top:50%; transform:translateY(-50%);
    background:transparent; color:#fff; border:0; font-size:42px; cursor:pointer;">‹</button>
    <!-- Sonraki -->
    <button id="lbNext" aria-label="Sonraki" style="
    position:absolute; right:2%; top:50%; transform:translateY(-50%);
    background:transparent; color:#fff; border:0; font-size:42px; cursor:pointer;">›</button>

    <!-- İçerik -->
    <div id="lbContent" style="max-width:92vw; max-height:92vh;"></div>
  </div>

  <script>
    // Lightbox state
    let LB_FILES = [];   // ['a.jpg','b.mp4', ...]
    let LB_INDEX = 0;
    const lb = document.getElementById('lightbox');
    const lbContent = document.getElementById('lbContent');

    function isImg(name) {
      const ext = name.split('.').pop()?.toLowerCase();
      return ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext);
    }
    function isVid(name) {
      const ext = name.split('.').pop()?.toLowerCase();
      return ['mp4', 'mov', 'webm', 'mkv', 'avi'].includes(ext);
    }

    function openLightbox(files, startIndex) {
      LB_FILES = files.slice();
      LB_INDEX = startIndex || 0;
      renderLB();
      lb.style.display = 'flex';
    }

    function closeLightbox() {
      // Video oynuyorsa durdur
      const v = lbContent.querySelector('video');
      if (v) { v.pause(); v.src = ''; }
      lb.style.display = 'none';
      lbContent.innerHTML = '';
    }

    function renderLB() {
      const name = LB_FILES[LB_INDEX];
      lbContent.innerHTML = '';
      if (isImg(name)) {
        const img = document.createElement('img');
        img.src = `/uploads/${encodeURI(name)}`;
        img.style.maxWidth = '92vw';
        img.style.maxHeight = '92vh';
        img.style.borderRadius = '10px';
        img.alt = name;
        lbContent.appendChild(img);
      } else if (isVid(name)) {
        const vid = document.createElement('video');
        vid.src = `/uploads/${encodeURI(name)}`;
        vid.controls = true;
        vid.autoplay = true;
        vid.style.maxWidth = '92vw';
        vid.style.maxHeight = '92vh';
        lbContent.appendChild(vid);
      } else {
        const p = document.createElement('p');
        p.textContent = name;
        p.style.color = '#fff';
        lbContent.appendChild(p);
      }
      // basit preload (ileri/geri)
      const next = LB_FILES[(LB_INDEX + 1) % LB_FILES.length];
      const prev = LB_FILES[(LB_INDEX - 1 + LB_FILES.length) % LB_FILES.length];
      if (next && isImg(next)) new Image().src = `/uploads/${encodeURI(next)}`;
      if (prev && isImg(prev)) new Image().src = `/uploads/${encodeURI(prev)}`;
    }

    function lbNext() {
      LB_INDEX = (LB_INDEX + 1) % LB_FILES.length;
      renderLB();
    }
    function lbPrev() {
      LB_INDEX = (LB_INDEX - 1 + LB_FILES.length) % LB_FILES.length;
      renderLB();
    }

    // Butonlar
    document.getElementById('lbClose').onclick = closeLightbox;
    document.getElementById('lbNext').onclick = lbNext;
    document.getElementById('lbPrev').onclick = lbPrev;

    // Arka plana tıklayınca kapat
    lb.addEventListener('click', (e) => {
      if (e.target === lb) closeLightbox();
    });

    // Klavye: ESC/←/→
    document.addEventListener('keydown', (e) => {
      if (lb.style.display === 'flex') {
        if (e.key === 'Escape') closeLightbox();
        if (e.key === 'ArrowRight') lbNext();
        if (e.key === 'ArrowLeft') lbPrev();
      }
    });

    // Dokunmatik swipe (telefon/tablet)
    let touchStartX = 0, touchEndX = 0;
    lb.addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
    lb.addEventListener('touchend', (e) => {
      touchEndX = e.changedTouches[0].screenX;
      const dx = touchEndX - touchStartX;
      if (Math.abs(dx) > 50) { // eşik
        if (dx < 0) lbNext(); else lbPrev();
      }
    }, { passive: true });
  </script>

</body>

</html>