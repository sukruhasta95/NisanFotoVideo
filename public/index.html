<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Merve & Şükrü Nişanı | Fotoğraf Yükle</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Quicksand', sans-serif;
      background: linear-gradient(to right, #fdfcfb, #e2d1c3);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 60px;
      color: #333;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }

    p {
      font-size: 18px;
      margin-bottom: 8px;
    }

    .btn {
      padding: 10px 25px;
      margin: 8px;
      font-size: 16px;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      transition: 0.3s;
    }

    #selectBtn {
      background: #888;
      color: #fff;
    }

    #selectBtn:hover {
      background: #555;
    }

    #uploadBtn {
      background: #222;
      color: #fff;
    }

    #uploadBtn:disabled {
      background: #ccc;
      color: #666;
      cursor: not-allowed;
    }

    #drop-zone {
      border: 2px dashed #aaa;
      border-radius: 15px;
      padding: 2%;
      padding-bottom: 4%;
      width: 90%;
      max-width: 600px;
      text-align: center;
      background: rgba(255, 255, 255, 0.9);
      transition: all 0.3s ease;
    }

    #fileCount {
      font-size: 16px;
      color: #444;
      margin-bottom: 20px;
    }

    input[type="file"] {
      display: none;
    }

    #preview-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      margin-top: 15px;
    }

    .preview {
      position: relative;
      width: 100px;
      height: 100px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
      background: #f9f9f9;
    }

    .preview img,
    .preview video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .remove-btn {
      position: absolute;
      top: 3px;
      right: 6px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 14px;
      cursor: pointer;
    }

    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #555;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-left: 10px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <h1>📸 Merve & Şükrü Nişan Anıları</h1>
  <p>Güzel anılarını bizimle paylaş!</p>
  <div id="fileCount"></div>
  <div id="drop-zone">
    <div id="progressWrapper" style="display:none; margin-top: 10px;">
      <div
        style="background: #eee; border-radius: 10px; overflow: hidden; height: 20px; width: 100%; max-width: 600px;">
        <div id="progressBar" style="height: 100%; width: 0%; background-color: #4caf50; transition: width 0.3s ease;">
        </div>
      </div>
      <div id="remainingTime" style="margin-top: 8px; font-size: 14px; color: #444;">Kalan süre: hesaplanıyor...</div>
    </div>
    <input type="file" id="fileInput" name="photos" accept="image/*,video/*" multiple />
    <button class="btn" id="selectBtn" onclick="document.getElementById('fileInput').click()">📁 Dosya Seç</button>
    <button class="btn" id="uploadBtn" onclick="uploadFiles()" disabled>⬆️ Yükle</button>
    <button class="btn" id="showGalleryBtn" onclick="toggleGallery()">📂 Anıları Göster</button>
    <div id="preview-container"></div>

    <div id="success-message"
      style="background-color: #d4edda; color: #155724; padding: 15px; border-radius: 10px; margin-top: 20px; display: none;">
      Katkınız için teşekkür ederiz! 🎉
    </div>
  </div>

  <div id="gallery" style="display: none; margin-top: 30px;">
    <h3 style="text-align: center;">Yüklenen Fotoğraf ve Videolar</h3>
    <div id="galleryContainer" style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;"></div>
    <div id="pagination" style="text-align: center; margin-top: 10px;"></div>
  </div>

  <script>
    const MAX_FILES = 20;
    const input = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const previewContainer = document.getElementById("preview-container");
    const fileCountEl = document.getElementById("fileCount");
    const successMessage = document.getElementById("success-message");
    const selectBtn = document.getElementById("selectBtn");
    const showGalleryBtn = document.getElementById("showGalleryBtn");
    let selectedFiles = [],
      currentPage = 1,
      totalPages = 1,
      pageSize = 20;

    input.addEventListener("change", () => {
      const newFiles = Array.from(input.files);
      newFiles.forEach(file => {
        const exists = selectedFiles.some(f => f.name === file.name && f.size === file.size);
        if (!exists) selectedFiles.push(file);
      });
      input.value = "";
      updatePreview();
    });

    function updatePreview() {
      previewContainer.innerHTML = "";
      uploadBtn.disabled = selectedFiles.length === 0;
      fileCountEl.innerText = selectedFiles.length ? `${selectedFiles.length} dosya seçildi` : "";
      selectedFiles.forEach((file, index) => {
        const preview = document.createElement("div");
        preview.className = "preview";
        const removeBtn = document.createElement("button");
        removeBtn.className = "remove-btn";
        removeBtn.innerText = "×";
        removeBtn.onclick = () => { selectedFiles.splice(index, 1); updatePreview(); };
        if (file.type.startsWith("image/")) {
          const img = document.createElement("img");
          img.src = URL.createObjectURL(file);
          preview.appendChild(img);
        } else if (file.type.startsWith("video/")) {
          const video = document.createElement("video");
          video.src = URL.createObjectURL(file);
          video.controls = true;
          preview.appendChild(video);
        }
        preview.appendChild(removeBtn);
        previewContainer.appendChild(preview);
      });
    }

    async function uploadFiles() {
      if (!selectedFiles.length) return alert('Dosya seçilmedi.');
      const newFiles = Array.from(input.files);
      if (selectedFiles.length + newFiles.length > MAX_FILES) {
        alert(`En fazla ${MAX_FILES} dosya yükleyebilirsiniz.`);
        return;
      }
      const formData = new FormData();
      for (const file of selectedFiles) formData.append('media', file);
      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/api/upload');
      const startTime = Date.now();
      xhr.upload.addEventListener('progress', e => {
        if (e.lengthComputable) {
          const percent = (e.loaded / e.total) * 100;
          const remaining = e.total - e.loaded;
          const uploadSpeedBytesPerSec = (estimatedUploadSpeedMbps * 1024 * 1024) / 8;
          const secondsRemaining = remaining / uploadSpeedBytesPerSec;

          document.getElementById('progressWrapper').style.display = 'block';
          document.getElementById('progressBar').style.width = percent.toFixed(1) + '%';

          if (secondsRemaining > 60) {
            const mins = Math.floor(secondsRemaining / 60);
            const secs = Math.ceil(secondsRemaining % 60);
            document.getElementById('remainingTime').innerText = `Kalan süre: ${mins} dakika ${secs} saniye`;
          } else {
            document.getElementById('remainingTime').innerText = `Kalan süre: ${Math.ceil(secondsRemaining)} saniye`;
          }
        }
      });

      xhr.onreadystatechange = () => {
        if (xhr.readyState === 4) {
          document.getElementById('progressBar').style.width = '100%';
          document.getElementById('remainingTime').innerText = 'Yükleme tamamlandı ✅';

          uploadBtn.disabled = false;
          uploadBtn.innerHTML = '⬆️ Yükle';
          selectBtn.disabled = false;
          showGalleryBtn.disabled = false;
          selectedFiles = [];
          updatePreview();
          setTimeout(() => {
            document.getElementById('progressWrapper').style.display = 'none';
            document.getElementById('success-message').style.display = 'block';
          }, 3000);
          setTimeout(() => {
            document.getElementById('success-message').style.display = 'none';
          }, 10000);
        }
      };

      uploadBtn.disabled = true;
      uploadBtn.innerHTML = 'Yükleniyor... <span class="loader"></span>';
      selectBtn.disabled = true;
      showGalleryBtn.disabled = true;

      xhr.send(formData);
    }
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.round(seconds % 60);
      return `${mins > 0 ? mins + ' dakika ' : ''}${secs} saniye`;
    }
    async function toggleGallery() {
      const gallery = document.getElementById("gallery");
      if (gallery.style.display === "none") {
        gallery.style.display = "block";
        await renderGallery(currentPage);
      } else {
        gallery.style.display = "none";
      }
    }

    async function renderGallery(page = 1) {
      const res = await fetch(`/uploads?page=${page}&pageSize=${pageSize}`);
      const result = await res.json();
      const container = document.getElementById("galleryContainer");
      container.innerHTML = "";
      totalPages = Math.ceil(result.total / result.pageSize);

      result.files.forEach(file => {
        const ext = file.split('.').pop().toLowerCase();
        const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext);
        const isVideo = ['mp4', 'mov', 'avi', 'webm'].includes(ext);
        const wrapper = document.createElement("div");
        wrapper.className = "gallery-item";
        wrapper.style = "position: relative; width: 160px; border: 1px solid #ccc; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.1); background: #fff;";

        if (isImage) {
          const img = document.createElement("img");
          img.src = `/uploads/${file}`;
          img.style = "width: 100%; height: 120px; object-fit: cover;";
          wrapper.appendChild(img);
        } else if (isVideo) {
          const vid = document.createElement("video");
          vid.src = `/uploads/${file}`;
          vid.controls = true;
          vid.style = "width: 100%; height: 120px;";
          wrapper.appendChild(vid);
        }
        container.appendChild(wrapper);
      });

      renderPagination();
    }

    function renderPagination() {
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.innerText = i;
        btn.className = "btn";
        btn.style = i === currentPage ? "background:#333; color:#fff;" : "background:#eee; color:#333;";
        btn.onclick = () => {
          currentPage = i;
          renderGallery(currentPage);
        };
        pagination.appendChild(btn);
      }
    }
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    function downloadSelected() {
      const checkboxes = document.querySelectorAll('.gallery-checkbox:checked');
      if (checkboxes.length === 0) {
        alert("Lütfen indirilecek dosya(ları) seçin.");
        return;
      }

      const zip = new JSZip();
      const folder = zip.folder("nisan-anilari");
      let count = 0;

      checkboxes.forEach(cb => {
        const filename = cb.value;
        fetch(`/uploads/${filename}`)
          .then(res => res.blob())
          .then(blob => {
            folder.file(filename, blob);
            count++;
            if (count === checkboxes.length) {
              zip.generateAsync({ type: "blob" }).then(content => {
                const a = document.createElement("a");
                a.href = URL.createObjectURL(content);
                a.download = "nisan-anilari.zip";
                a.click();
              });
            }
          });
      });
    }
  </script>

  <script>
    let estimatedUploadSpeedMbps = 15;
    async function testUploadSpeed() {
      const size = 5 * 1024 * 1024;
      const testData = new Uint8Array(size).fill(97);

      const start = performance.now();
      await fetch("/upload-speed-test", {
        method: "POST",
        body: testData
      });
      const duration = (performance.now() - start) / 1000; // saniye
      const speedBps = size / duration;
      const speedMbps = (speedBps * 8) / (1024 * 1024);
      estimatedUploadSpeedMbps = speedMbps;
      console.log(`estimatedUploadSpeedMbps: ${estimatedUploadSpeedMbps} mbps`);
    }
    testUploadSpeed();
  </script>

</body>

</html>