<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Merve & ≈û√ºkr√º Ni≈üan</title>
  <link rel="icon" href="https://img.icons8.com/?size=100&id=8OAchvfXUeyE&format=png&color=000000" type="image/png">
  <style>
    body {
      font-family: 'Quicksand', sans-serif;
      background: linear-gradient(to right, #fdfcfb, #e2d1c3);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 60px;
      color: #333;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }

    p {
      font-size: 18px;
      margin-bottom: 8px;
    }

    .btn {
      padding: 10px 25px;
      margin: 8px;
      font-size: 16px;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      transition: 0.3s;
    }

    #selectBtn {
      background: #888;
      color: #fff;
    }

    #selectBtn:hover {
      background: #555;
    }

    #uploadBtn {
      background: #222;
      color: #fff;
    }

    #uploadBtn:disabled {
      background: #ccc;
      color: #666;
      cursor: not-allowed;
    }

    #drop-zone {
      border: 2px dashed #aaa;
      border-radius: 15px;
      padding: 2%;
      padding-bottom: 4%;
      width: 90%;
      max-width: 600px;
      text-align: center;
      background: rgba(255, 255, 255, 0.9);
      transition: all 0.3s ease;
    }

    #drop-zone.dragover {
      border-color: #4caf50;
      background: rgba(255, 255, 255, 0.95);
    }

    #fileCount {
      font-size: 16px;
      color: #444;
      margin-bottom: 20px;
    }

    input[type="file"] {
      display: none;
    }

    #preview-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      margin-top: 15px;
    }

    .preview {
      position: relative;
      width: 100px;
      height: 100px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
      background: #f9f9f9;
    }

    .preview img,
    .preview video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .remove-btn {
      position: absolute;
      top: 3px;
      right: 6px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 14px;
      cursor: pointer;
    }

    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #555;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-left: 10px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Se√ßim Modalƒ± */
    #pickerOverlay {
      display: none !important;
      position: fixed;
      inset: 0;
      z-index: 9999;
      background: rgba(0, 0, 0, .6);
      align-items: center;
      justify-content: center;
    }

    .picker-sheet {
      background: #111;
      color: #fff;
      width: min(520px, 92vw);
      border-radius: 16px;
      padding: 16px;
      text-align: center;
    }

    .picker-sheet .btn {
      width: 100%;
    }

    .hint {
      opacity: .85;
      font-size: 13px;
      margin-top: 6px
    }
  </style>
</head>

<body>
  <h1 style="font-size:x-large;">üì∏ Merve & ≈û√ºkr√º Ni≈üan Anƒ±larƒ±</h1>
  <p style="font-size:larger;"> G√ºzel anƒ±larƒ±nƒ± bizimle payla≈ü!</p>
  <div id="fileCount"></div>

  <div id="pickerOverlay">
    <div class="picker-sheet">
      <h3 style="margin:6px 0 12px">Ne y√ºklemek istiyorsun?</h3>
      <button class="btn" id="btnCamera" style="background:#1e90ff; color:#fff;">üì∑ Kameradan √áek</button>
      <button class="btn" id="btnFiles" style="background:#00b894; color:#fff;">üìÅ Dosyalardan Se√ß</button>
    </div>
  </div>

  <div id="drop-zone">
    <div id="progressWrapper" style="display:none; margin-top: 10px;">
      <div
        style="background: #eee; border-radius: 10px; overflow: hidden; height: 20px; width: 100%; max-width: 600px;">
        <div id="progressBar" style="height: 100%; width: 0%; background-color: #4caf50; transition: width 0.3s ease;">
        </div>
      </div>
      <div id="remainingTime" style="margin-top: 8px; font-size: 14px; color: #444;">Kalan s√ºre: hesaplanƒ±yor...</div>
    </div>

    <input type="file" id="fileInput" name="photos" accept="image/*,video/*" multiple />

    <input id="inpCamera" type="file" accept="image/*,video/*" capture="environment" multiple hidden>
    <input id="inpFiles" type="file" accept="image/*,video/*" multiple hidden>

    <button class="btn" id="selectBtn" onclick="openPicker()">üìÅ Dosya Se√ß</button>
    <button class="btn" id="uploadBtn" onclick="uploadFiles()" disabled>‚¨ÜÔ∏è Y√ºkle</button>
    <button class="btn" id="showGalleryBtn" onclick="toggleGallery()">üìÇ Anƒ±larƒ± G√∂ster</button>

    <div id="preview-container"></div>

    <div id="success-message"
      style="background-color: #d4edda; color: #155724; padding: 15px; border-radius: 10px; margin-top: 20px; display: none;">
      Katkƒ±nƒ±z i√ßin te≈üekk√ºr ederiz! üéâ
    </div>
  </div>

  <div id="gallery" style="display: none; margin-top: 30px;">
    <h3 style="text-align: center;">Y√ºklenen Fotoƒüraf ve Videolar</h3>
    <div id="galleryContainer" style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;"></div>
    <div id="pagination" style="text-align: center; margin-top: 10px;"></div>
  </div>
  <div id="imgModal" style="
  display:none; 
  position:fixed; 
  z-index:99999; 
  top:0; left:0; right:0; bottom:0; 
  background:rgba(0,0,0,0.9); 
  justify-content:center; 
  align-items:center;">
    <span onclick="closeImgModal()" style="
    position:absolute; 
    top:20px; 
    right:35px; 
    color:#fff; 
    font-size:40px; 
    font-weight:bold; 
    cursor:pointer;">&times;</span>
    <img id="imgModalContent" style="max-width:90%; max-height:90%; border-radius:10px;">
  </div>

  <script>
    function openImgModal(src) {
      const modal = document.getElementById('imgModal');
      document.getElementById('imgModalContent').src = src;
      modal.style.display = 'flex';
    }

    function closeImgModal() {
      document.getElementById('imgModal').style.display = 'none';
    }

    document.getElementById('imgModal').addEventListener('click', function (e) {
      if (e.target.id === 'imgModal') {
        closeImgModal();
      }
    });
  </script>

  <script>
    const MAX_FILES = 20;
    const input = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const previewContainer = document.getElementById("preview-container");
    const fileCountEl = document.getElementById("fileCount");
    const successMessage = document.getElementById("success-message");
    const selectBtn = document.getElementById("selectBtn");
    const showGalleryBtn = document.getElementById("showGalleryBtn");

    const overlay = document.getElementById('pickerOverlay');
    const inpCamera = document.getElementById('inpCamera');
    const inpFiles = document.getElementById('inpFiles');
    const dropZone = document.getElementById('drop-zone');

    let selectedFiles = [], currentPage = 1, totalPages = 1, pageSize = 20;

    function openPicker() { inpFiles.click(); }
    function closePicker() { overlay.style.display = 'none'; }
    overlay.addEventListener('click', (e) => { if (e.target === overlay) closePicker(); });
    document.getElementById('btnCamera').onclick = () => inpCamera.click();
    document.getElementById('btnFiles').onclick = () => inpFiles.click();

    function addFiles(files) {
      const onlyMedia = Array.from(files).filter(f => f.type.startsWith('image/') || f.type.startsWith('video/'));
      const remaining = Math.max(0, MAX_FILES - selectedFiles.length);
      const take = onlyMedia.slice(0, remaining);

      let added = 0;
      take.forEach(file => {
        const exists = selectedFiles.some(f => f.name === file.name && f.size === file.size);
        if (!exists) { selectedFiles.push(file); added++; }
      });

      if (onlyMedia.length > take.length) {
        alert(`En fazla ${MAX_FILES} dosya y√ºkleyebilirsiniz. (${MAX_FILES} sƒ±nƒ±rƒ±)`);
      }
      if (added === 0 && onlyMedia.length) {
        console.warn('Aynƒ± dosyalar tekrar se√ßildi, eklenmedi.');
      }
      updatePreview();
    }

    input.addEventListener("change", () => {
      if (input.files?.length) addFiles(input.files);
      input.value = "";
    });

    [inpCamera, inpFiles].forEach(inp => {
      inp.addEventListener('change', e => {
        if (e.target.files?.length) addFiles(e.target.files);
        e.target.value = '';
        closePicker();
      });
    });

    ['dragenter', 'dragover'].forEach(ev => {
      dropZone.addEventListener(ev, e => { e.preventDefault(); dropZone.classList.add('dragover'); });
    });
    ['dragleave', 'drop'].forEach(ev => {
      dropZone.addEventListener(ev, e => { e.preventDefault(); dropZone.classList.remove('dragover'); });
    });
    dropZone.addEventListener('drop', e => {
      if (e.dataTransfer?.files?.length) addFiles(e.dataTransfer.files);
    });

    window.addEventListener('paste', e => {
      const items = e.clipboardData?.items || [];
      const pasted = [];
      for (const it of items) {
        if (it.type?.startsWith('image/') || it.type?.startsWith('video/')) {
          const file = it.getAsFile();
          if (file) pasted.push(file);
        }
      }
      if (pasted.length) addFiles(pasted);
    });

    function updatePreview() {
      previewContainer.innerHTML = "";
      uploadBtn.disabled = selectedFiles.length === 0;
      fileCountEl.innerText = selectedFiles.length ? `${selectedFiles.length} dosya se√ßildi` : "";
      selectedFiles.forEach((file, index) => {
        const preview = document.createElement("div");
        preview.className = "preview";
        const removeBtn = document.createElement("button");
        removeBtn.className = "remove-btn";
        removeBtn.innerText = "√ó";
        removeBtn.onclick = () => { selectedFiles.splice(index, 1); updatePreview(); };
        if (file.type.startsWith("image/")) {
          const img = document.createElement("img");
          img.src = URL.createObjectURL(file);
          preview.appendChild(img);
        } else if (file.type.startsWith("video/")) {
          const video = document.createElement("video");
          video.src = URL.createObjectURL(file);
          video.controls = true;
          preview.appendChild(video);
        }
        preview.appendChild(removeBtn);
        previewContainer.appendChild(preview);
      });
    }

    async function uploadFiles() {
      if (!selectedFiles.length) return alert('Dosya se√ßilmedi.');
      if (selectedFiles.length > MAX_FILES) {
        alert(`En fazla ${MAX_FILES} dosya y√ºkleyebilirsiniz.`);
        return;
      }

      const formData = new FormData();
      for (const file of selectedFiles) formData.append('media', file);

      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/api/upload');

      xhr.upload.addEventListener('progress', e => {
        if (e.lengthComputable) {
          const percent = (e.loaded / e.total) * 100;
          const remaining = e.total - e.loaded;
          const uploadSpeedBytesPerSec = (estimatedUploadSpeedMbps * 1024 * 1024) / 8;
          const secondsRemaining = remaining / uploadSpeedBytesPerSec;

          document.getElementById('progressWrapper').style.display = 'block';
          document.getElementById('progressBar').style.width = percent.toFixed(1) + '%';
          document.getElementById('remainingTime').innerText =
            secondsRemaining > 60
              ? `Kalan s√ºre: ${Math.floor(secondsRemaining / 60)} dakika ${Math.ceil(secondsRemaining % 60)} saniye`
              : `Kalan s√ºre: ${Math.ceil(secondsRemaining)} saniye`;
        }
      });

      xhr.onreadystatechange = () => {
        if (xhr.readyState === 4) {
          document.getElementById('progressBar').style.width = '100%';
          document.getElementById('remainingTime').innerText = 'Y√ºkleme tamamlandƒ± ‚úÖ';

          uploadBtn.disabled = false; uploadBtn.innerHTML = '‚¨ÜÔ∏è Y√ºkle';
          selectBtn.disabled = false; showGalleryBtn.disabled = false;
          selectedFiles = []; updatePreview();

          setTimeout(() => {
            document.getElementById('progressWrapper').style.display = 'none';
            document.getElementById('success-message').style.display = 'block';
          }, 3000);
          setTimeout(() => { document.getElementById('success-message').style.display = 'none'; }, 10000);
        }
      };

      uploadBtn.disabled = true;
      uploadBtn.innerHTML = 'Y√ºkleniyor... <span class="loader"></span>';
      selectBtn.disabled = true; showGalleryBtn.disabled = true;

      xhr.send(formData);
    }

    async function toggleGallery() {
      const gallery = document.getElementById("gallery");
      if (gallery.style.display === "none") {
        gallery.style.display = "block";
        await renderGallery(currentPage);
      } else {
        gallery.style.display = "none";
      }
    }

    async function renderGallery(page = 1) {
      const res = await fetch(`/uploads?page=${page}&pageSize=${pageSize}`);
      const result = await res.json();
      const container = document.getElementById("galleryContainer");
      container.innerHTML = "";
      totalPages = Math.ceil(result.total / result.pageSize);

      result.files.forEach(file => {
        const ext = file.split('.').pop().toLowerCase();
        const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext);
        const isVideo = ['mp4', 'mov', 'avi', 'webm'].includes(ext);
        const wrapper = document.createElement("div");
        wrapper.className = "gallery-item";
        wrapper.style = "position: relative; width: 160px; border: 1px solid #ccc; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.1); background: #fff;";

        if (isImage) {
          const img = document.createElement("img");
          img.src = `/uploads/${file}`;
          img.style = "width: 100%; height: 120px; object-fit: cover;";
          img.onclick = () => openImgModal(img.src);
          wrapper.appendChild(img);
        } else if (isVideo) {
          const vid = document.createElement("video");
          vid.src = `/uploads/${file}`;
          vid.controls = true;
          vid.style = "width: 100%; height: 120px;";
          wrapper.appendChild(vid);
        }
        container.appendChild(wrapper);
      });

      renderPagination();
    }

    function renderPagination() {
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.innerText = i;
        btn.className = "btn";
        btn.style = i === currentPage ? "background:#333; color:#fff;" : "background:#eee; color:#333;";
        btn.onclick = () => { currentPage = i; renderGallery(currentPage); };
        pagination.appendChild(btn);
      }
    }
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    function downloadSelected() {
      const checkboxes = document.querySelectorAll('.gallery-checkbox:checked');
      if (checkboxes.length === 0) { alert("L√ºtfen indirilecek dosya(larƒ±) se√ßin."); return; }
      const zip = new JSZip(); const folder = zip.folder("nisan-anilari"); let count = 0;
      checkboxes.forEach(cb => {
        const filename = cb.value;
        fetch(`/uploads/${filename}`).then(res => res.blob()).then(blob => {
          folder.file(filename, blob); count++;
          if (count === checkboxes.length) {
            zip.generateAsync({ type: "blob" }).then(content => {
              const a = document.createElement("a");
              a.href = URL.createObjectURL(content); a.download = "nisan-anilari.zip"; a.click();
            });
          }
        });
      });
    }
  </script>

  <script>
    let estimatedUploadSpeedMbps = 15;
    async function testUploadSpeed() {
      const size = 5 * 1024 * 1024;
      const testData = new Uint8Array(size).fill(97);
      const start = performance.now();
      await fetch("/upload-speed-test", { method: "POST", body: testData });
      const duration = (performance.now() - start) / 1000;
      const speedBps = size / duration;
      const speedMbps = (speedBps * 8) / (1024 * 1024);
      estimatedUploadSpeedMbps = speedMbps;
      console.log(`estimatedUploadSpeedMbps: ${estimatedUploadSpeedMbps} mbps`);
    }
    testUploadSpeed();
  </script>
</body>

</html>